<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Note: X-Frame-Options and some CSP directives can only be set via HTTP headers -->
    <!-- In actual WordPress environment, they are sent as HTTP headers via PHP -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; base-uri 'self'; form-action 'self';">
    <title>Bead Pattern Designer - Production Test</title>

    <!-- WordPress environment simulation -->
    <style>
        /* WordPress admin style simulation */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background: #f1f1f1;
            margin: 0;
            padding: 20px;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.04);
        }

        .card {
            background: #fff;
            border: 1px solid #ccd0d4;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 1px 1px rgba(0,0,0,0.04);
        }

        h1, h2, h3 {
            color: #23282d;
        }

        code {
            background: #f3f4f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, Monaco, monospace;
        }

        .test-section {
            border: 2px solid #0073aa;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .security-test {
            background: #f0f8ff;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #0073aa;
        }

        .success {
            color: #46b450;
            font-weight: bold;
        }

        .error {
            color: #dc3232;
            font-weight: bold;
        }

        .warning {
            color: #ffb900;
            font-weight: bold;
        }

        #security-results {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>

    <!-- Plugin CSS -->
    <link rel="stylesheet" href="bead-pattern-designer/assets/bundle.css">
</head>
<body>
    <div class="wrap">
        <h1>üîí Bead Pattern Designer - Production Environment Test</h1>

        <div class="card">
            <h2>1. Security Headers Test</h2>
            <div class="security-test">
                <p>‚úÖ CSP (Content Security Policy) Active - <span class="success">Working!</span></p>
                <p>‚ö†Ô∏è X-Frame-Options: Can only be set via HTTP headers (handled by PHP in WordPress)</p>
                <p>‚ö†Ô∏è X-XSS-Protection: Can only be set via HTTP headers</p>
                <p>‚ö†Ô∏è X-Content-Type-Options: Can only be set via HTTP headers</p>
                <p class="warning">üí° Console warnings are normal. In actual WordPress, sent as HTTP headers.</p>
            </div>
        </div>

        <div class="card">
            <h2>2. XSS Attack Simulation Test</h2>
            <div class="test-section">
                <h3>Malicious Script Injection Attempt:</h3>

                <!-- XSS Test 1: Event Handler -->
                <div id="xss-test-1" class="test' onmouseover='alert(1)' data-test='">
                    Alert should NOT execute when hovering over this area.
                </div>

                <!-- XSS Test 2: JavaScript URL -->
                <div id="xss-test-2" style="width: 100px; background-image: url('javascript:alert(2)');">
                    JavaScript URL should be blocked.
                </div>

                <!-- XSS Test 3: HTML Injection -->
                <div id="xss-test-3"></div>

                <div id="security-results"></div>
            </div>
        </div>

        <div class="card">
            <h2>3. Plugin Instance Test</h2>

            <!-- Normal Instance -->
            <div class="test-section">
                <h3>Instance #1 (Normal)</h3>
                <div id="bpd-test1" class="bead-pattern-designer-container" style="width: 100%; min-height: 400px; position: relative;" data-nonce="test-nonce-1"></div>
            </div>

            <!-- CSS Validation Test -->
            <div class="test-section">
                <h3>Instance #2 (CSS Validation Test)</h3>
                <div id="bpd-test2" class="bead-pattern-designer-container" style="width: 80%; min-height: 300px; position: relative;" data-nonce="test-nonce-2"></div>
            </div>
        </div>

        <div class="card">
            <h2>4. Rate Limiting Simulation</h2>
            <div class="test-section">
                <button onclick="testRateLimit()">Rate Limit Test (Click)</button>
                <div id="rate-limit-result"></div>
            </div>
        </div>

        <div class="card">
            <h2>5. Nonce Verification Test</h2>
            <div class="test-section">
                <button onclick="testNonceValidation()">Nonce Verification Test</button>
                <div id="nonce-result"></div>
            </div>
        </div>

        <div class="card">
            <h2>6. Obfuscation Verification</h2>
            <div class="test-section">
                <button onclick="checkObfuscation()">Check JavaScript Obfuscation</button>
                <div id="obfuscation-result"></div>
            </div>
        </div>
    </div>

    <!-- Plugin JavaScript -->
    <script src="bead-pattern-designer/assets/bundle.js"></script>

    <!-- Test Script -->
    <script>
        // WordPress environment simulation
        window.bpdNonce = 'test-nonce-' + Math.random().toString(36).substr(2, 9);

        // Initialize security tests
        document.addEventListener('DOMContentLoaded', function() {
            runSecurityTests();
        });

        // XSS Tests
        function runSecurityTests() {
            const results = document.getElementById('security-results');
            let testResults = '=== XSS Security Test Results ===\n\n';

            // Test 1: Event handler blocking
            const test1 = document.getElementById('xss-test-1');
            if (!test1.onmouseover) {
                testResults += '‚úÖ Test 1 Passed: Event handler injection blocked\n';
            } else {
                testResults += '‚ùå Test 1 Failed: Event handler can be executed\n';
            }

            // Test 2: JavaScript URL blocking
            const test2 = document.getElementById('xss-test-2');
            const bgImage = window.getComputedStyle(test2).backgroundImage;
            if (!bgImage || bgImage === 'none' || !bgImage.includes('javascript:')) {
                testResults += '‚úÖ Test 2 Passed: JavaScript URL blocked (CSP blocked it)\n';
                testResults += ' is normal\n';
            } else {
                testResults += '‚ùå Test 2 Failed: JavaScript URL can be executed\n';
            }

            // Test 3: HTML injection attempt
            try {
                const maliciousHTML = '<img src=x onerror="alert(3)">';
                const sanitized = sanitizeHTML(maliciousHTML);
                if (!sanitized.includes('onerror')) {
                    testResults += '‚úÖ Test 3 Passed: HTML injection blocked\n';
                } else {
                    testResults += '‚ùå Test 3 Failed: HTML injection possible\n';
                }
            } catch(e) {
                testResults += '‚ö†Ô∏è Test 3: sanitizeHTML function not found (server-side processing required)\n';
            }

            // CSP Test
            try {
                eval('console.log("CSP Test")');
                testResults += '‚ö†Ô∏è CSP Warning: eval() can be executed (due to unsafe-inline)\n';
            } catch(e) {
                testResults += '‚úÖ CSP Test Passed: eval() blocked\n';
            }

            results.textContent = testResults;
        }

        // Rate Limiting Test
        let requestCount = 0;
        function testRateLimit() {
            requestCount++;
            const resultDiv = document.getElementById('rate-limit-result');

            if (requestCount <= 10) {
                resultDiv.innerHTML = `<span class="success">Request ${requestCount}/10 - Processed normally</span>`;
            } else {
                resultDiv.innerHTML = `<span class="error">Request ${requestCount}/10 - Rate Limit exceeded! Request blocked</span>`;
            }

            // Reset after 1 minute
            if (requestCount === 1) {
                setTimeout(() => {
                    requestCount = 0;
                    resultDiv.innerHTML += '<br><span class="warning">Rate limit reset</span>';
                }, 60000);
            }
        }

        // Nonce Verification Test
        function testNonceValidation() {
            const resultDiv = document.getElementById('nonce-result');
            const validNonce = window.bpdNonce;
            const invalidNonce = 'invalid-nonce-12345';

            resultDiv.innerHTML = `
                <p>Valid Nonce: <code>${validNonce}</code> - <span class="success">‚úÖ Verification passed</span></p>
                <p>Invalid Nonce: <code>${invalidNonce}</code> - <span class="error">‚ùå Verification failed</span></p>
                <p class="warning">In production, server-side verification is performed.</p>
            `;
        }

        // Obfuscation Verification
        function checkObfuscation() {
            const resultDiv = document.getElementById('obfuscation-result');
            const script = document.querySelector('script[src*="bundle.js"]');

            if (script) {
                fetch(script.src)
                    .then(response => response.text())
                    .then(code => {
                        const codeSnippet = code.substring(0, 500);
                        const hasConsoleLog = code.includes('console.log');
                        const hasDebugger = code.includes('debugger');
                        const hasComments = code.includes('//') || code.includes('/*');
                        const isMinified = code.length < 100000 && !code.includes('\n\n');

                        let results = '<h4>Obfuscation Verification Results:</h4>';
                        results += `<p>${!hasConsoleLog ? '‚úÖ' : '‚ùå'} console.log removal: ${!hasConsoleLog ? 'Passed' : 'Failed'}</p>`;
                        results += `<p>${!hasDebugger ? '‚úÖ' : '‚ùå'} debugger removal: ${!hasDebugger ? 'Passed' : 'Failed'}</p>`;
                        results += `<p>${!hasComments ? '‚úÖ' : '‚ùå'} Comment removal: ${!hasComments ? 'Passed' : 'Failed'}</p>`;
                        results += `<p>${isMinified ? '‚úÖ' : '‚ùå'} Code minification: ${isMinified ? 'Passed' : 'Failed'}</p>`;
                        results += `<p>File size: ${(code.length / 1024).toFixed(2)} KB</p>`;
                        results += `<details><summary>Code sample (first 500 chars)</summary><pre style="overflow-x: auto; font-size: 10px;">${escapeHtml(codeSnippet)}</pre></details>`;

                        resultDiv.innerHTML = results;
                    })
                    .catch(error => {
                        resultDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                    });
            }
        }

        // HTML escape helper
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Mock sanitizeHTML (actually processed server-side)
        function sanitizeHTML(html) {
            return html.replace(/<[^>]*>/g, '');
        }
    </script>
</body>
</html>